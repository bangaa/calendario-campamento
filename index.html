<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calendario Campamento - Semana Santa 2026</title>

<!-- Firebase (v8) - se usan si pegas tu config m√°s abajo -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<style>
:root{
  --bg:#f4fbf6;
  --card:#ffffff;
  --accent:#2f855a;
  --muted:#6b7280;
  --hour-height:60px;
  --start-hour:8;
  --end-hour:23;
}
*{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
body{margin:0;background:var(--bg);color:#0f172a;padding:12px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{margin:0;font-size:18px}
.wrap{display:grid;grid-template-columns:360px 1fr;gap:14px;margin-top:12px;align-items:start;}

/* panel */
.panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input[type=text], textarea, select, input[type=time], input[type=color]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6edf3;margin-top:6px}
textarea{min-height:80px;resize:vertical}
.row{display:flex;gap:8px}
.btn{display:inline-block;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.btn-primary{background:var(--accent);color:white}
.btn-ghost{background:transparent;border:1px solid #e6edf3}
.small{font-size:13px}
.muted{color:var(--muted);font-size:13px}

/* calendario */
.calendar{background:transparent}
.calendar-grid{display:grid;grid-template-columns:80px repeat(4,1fr);gap:8px;align-items:start}
.col-header{height:44px;display:flex;align-items:center;justify-content:center;font-weight:600;background:linear-gradient(90deg, rgba(47,133,90,0.08), rgba(47,133,90,0.02));border-radius:8px;padding:6px}
.hour-col{display:flex;flex-direction:column}
.hour-label{height:var(--hour-height);text-align:right;padding-right:10px;padding-top:8px;color:var(--muted);font-size:13px}
.day-column{background:var(--card);border-radius:8px;padding:0;position:relative;overflow:hidden;min-height:calc((var(--end-hour) - var(--start-hour)) * var(--hour-height));height:calc((var(--end-hour) - var(--start-hour)) * var(--hour-height));box-shadow:0 4px 14px rgba(2,6,23,0.04)}
.hour-line{height:var(--hour-height);border-bottom:1px dashed #eef2f6}

/* actividad */
.activity{
  position:absolute;
  border-radius:10px;
  padding:8px 10px;
  color:#fff;
  box-shadow:0 6px 12px rgba(2,6,23,0.12);
  font-size:14px;
  cursor:pointer;
  overflow:hidden;
  line-height:1.2;
  z-index:5;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  justify-content:center;
  min-width:48px;
  user-select:none;
}
.activity:focus{outline:3px solid rgba(255,255,255,0.18);outline-offset:2px}
.activity .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.activity .desc{font-size:12px;opacity:0.95;white-space:normal;overflow:hidden;margin-top:6px;line-height:1.2}

/* tiny status */
#syncStatus{font-size:12px;color:var(--muted)}

/* MOBILE: mobile-first tweaks */
@media (max-width:900px){
  body{padding:8px}
  .wrap{grid-template-columns:1fr;gap:10px}
  .panel{order:-1}
  .calendar-grid{
    grid-template-columns:60px repeat(4, minmax(220px, 1fr));
    gap:10px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    padding-bottom:10px;
  }
  .col-header{font-size:15px;padding:8px 10px}
  .hour-label{padding-right:6px;font-size:12px;height:48px}
  .activity{padding:8px 10px;font-size:15px;border-radius:12px}
  .panel{padding:10px}
  .btn{padding:10px 12px;font-size:15px}
}

/* VERY NARROW: list fallback (one-column per day stacked) */
@media (max-width:420px){
  /* Instead of trying to fit 4 days horizontally, show stacked day summaries under calendar */
  .calendar-grid{grid-template-columns:1fr}
  .day-column{min-height:200px;height:auto;padding:10px}
  .hour-col{display:none}
}
</style>
</head>
<body>
<header>
  <div>
    <h1>üìÖ Calendario - Campamento Semana Santa 2026</h1>
    <div id="syncStatus" class="muted">Modo: local (sin Firebase)</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button id="btnPrint" class="btn btn-ghost small">Imprimir / Guardar PDF</button>
    <button id="btnExport" class="btn btn-ghost small">Descargar JSON</button>
    <button id="btnImport" class="btn btn-ghost small">Importar JSON</button>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Crear / Editar actividad</strong>
      <button id="btnReset" class="btn btn-ghost small">Limpiar</button>
    </div>

    <label>D√≠a</label>
    <select id="inputDay">
      <option>Viernes 27</option>
      <option>S√°bado 28</option>
      <option>Domingo 29</option>
      <option>Lunes 30</option>
    </select>

    <div class="row">
      <div style="flex:1">
        <label>Inicio</label>
        <input id="inputStart" type="time" value="08:00" />
      </div>
      <div style="flex:1">
        <label>Fin</label>
        <input id="inputEnd" type="time" value="09:00" />
      </div>
    </div>

    <label>Nombre</label>
    <input id="inputTitle" type="text" placeholder="Ej. Ruta por la sierra" />

    <label>Descripci√≥n</label>
    <textarea id="inputDesc" placeholder="Detalles, materiales, qui√©n dirige..."></textarea>

    <label>Color</label>
    <input id="inputColor" type="color" value="#60a5fa" />

    <div class="controls" style="display:flex;gap:8px;margin-top:10px">
      <button id="btnAdd" class="btn btn-primary">A√±adir actividad</button>
      <button id="btnUpdate" class="btn btn-ghost" style="display:none">Guardar cambios</button>
      <button id="btnDelete" class="btn btn-ghost" style="display:none">Borrar</button>
    </div>

    <div class="footer muted" style="margin-top:10px">Las actividades se guardan localmente. Si configuras Firebase, se sincronizar√°n en tiempo real entre todos.</div>
  </div>

  <div class="calendar panel">
    <div class="calendar-grid" id="calendarGrid">
      <div></div>
      <div class="col-header">Viernes 27</div>
      <div class="col-header">S√°bado 28</div>
      <div class="col-header">Domingo 29</div>
      <div class="col-header">Lunes 30</div>

      <div class="hour-col" id="hoursCol"></div>
      <div class="day-column" data-day="Viernes 27"></div>
      <div class="day-column" data-day="S√°bado 28"></div>
      <div class="day-column" data-day="Domingo 29"></div>
      <div class="day-column" data-day="Lunes 30"></div>
    </div>
  </div>
</div>

<input id="fileInput" type="file" accept="application/json" style="display:none" />

<script>
/* =======================
   Configuraci√≥n: pega tu firebaseConfig aqu√≠ si quieres sincronizar
   Si NO pegas nada, la p√°gina funcionar√° solo en localStorage.
   ======================= */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAhzhr7P7m1CDYZhQPwtP78OEm6jGwwDGE",
  authDomain: "camp-sem-sant.firebaseapp.com",
  databaseURL: "https://camp-sem-sant-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "camp-sem-sant",
  storageBucket: "camp-sem-sant.firebasestorage.app",
  messagingSenderId: "483863490995",
  appId: "1:483863490995:web:5474b5a0984553baf29bc6"
};
let REMOTE_ENABLED = true; // se activar√° si config v√°lida

/* =======================
   Variables UI y tiempo
   ======================= */
const DAYS=["Viernes 27","S√°bado 28","Domingo 29","Lunes 30"];
const START_H=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--start-hour'))||8;
const END_H=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--end-hour'))||23;
const HOUR_H=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--hour-height'))||60;

const hoursCol=document.getElementById('hoursCol');
const dayCols=Array.from(document.querySelectorAll('.day-column'));
const syncStatusEl = document.getElementById('syncStatus');

/* crear filas de horas */
for(let h=START_H; h<END_H; h++){
  const lab=document.createElement('div'); lab.className='hour-label'; lab.textContent=String(h).padStart(2,'0')+":00";
  hoursCol.appendChild(lab);
  dayCols.forEach(c=>{ const line=document.createElement('div'); line.className='hour-line'; c.appendChild(line); });
}

/* utilidades */
const timeToMinutes=t=>{ const [hh,mm]=String(t||'').split(':').map(Number); return Number.isNaN(hh)||Number.isNaN(mm)?0:hh*60+mm; };
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const STORAGE_KEY = 'campamento-semanasanta-2026';
let activities = [];

/* elementos formulario */
const inputDay=document.getElementById('inputDay');
const inputStart=document.getElementById('inputStart');
const inputEnd=document.getElementById('inputEnd');
const inputTitle=document.getElementById('inputTitle');
const inputDesc=document.getElementById('inputDesc');
const inputColor=document.getElementById('inputColor');
const btnAdd=document.getElementById('btnAdd');
const btnUpdate=document.getElementById('btnUpdate');
const btnDelete=document.getElementById('btnDelete');
const btnReset=document.getElementById('btnReset');
const btnPrint=document.getElementById('btnPrint');
const btnExport=document.getElementById('btnExport');
const btnImport=document.getElementById('btnImport');
const fileInput=document.getElementById('fileInput');

let editingId = null;

/* =======================
   C√≥digo Firebase (si pegas config)
   ======================= */
let dbRef = null;
let remoteLoaded = false;

function initFirebaseIfConfigured(){
  try{
    // detectar si config tiene propiedades (min 3 keys)
    if(FIREBASE_CONFIG && Object.keys(FIREBASE_CONFIG).length > 2 && typeof firebase !== 'undefined'){
      firebase.initializeApp(FIREBASE_CONFIG);
      // auth an√≥nimo
      firebase.auth().signInAnonymously().catch(()=>{/* no cr√≠tico */});
      dbRef = firebase.database().ref('activities');
      REMOTE_ENABLED = true;
      syncStatusEl.textContent = 'Modo: sincronizaci√≥n activa (Firebase)';
      attachFirebaseListeners();
      console.log('Firebase inicializado: sincronizaci√≥n activada');
    } else {
      REMOTE_ENABLED = false;
      syncStatusEl.textContent = 'Modo: local (sin Firebase)';
      console.log('Firebase no configurado. Usando localStorage como fallback.');
    }
  }catch(err){
    REMOTE_ENABLED = false;
    syncStatusEl.textContent = 'Modo: local (error Firebase)';
    console.warn('Error inicializando Firebase:', err);
  }
}

function attachFirebaseListeners(){
  if(!dbRef) return;
  // escuchamos snapshot completo (sencillo). Para optimizar se puede usar child_added/changed/removed.
  dbRef.on('value', snapshot=>{
    const data = snapshot.val() || {};
    activities = Object.keys(data).map(k => ({ id: k, ...data[k] }));
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(activities)); }catch(e){}
    renderAll();
    remoteLoaded = true;
  });
  // conexi√≥n (opcional) para saber si estamos online
  const connRef = firebase.database().ref('.info/connected');
  connRef.on('value', snap=>{
    if(snap.val() === true){
      syncStatusEl.textContent = 'Modo: sincronizaci√≥n activa (Firebase) ‚Äî conectado';
    } else {
      // if disconnected, keep note
      syncStatusEl.textContent = 'Modo: sincronizaci√≥n activa (Firebase) ‚Äî desconectado';
    }
  });
}

/* funciones remotas */
function pushActivityToRemote(a){
  if(!dbRef) return Promise.reject('No remote');
  if(a.id){
    const id=a.id; const copy={...a}; delete copy.id;
    return dbRef.child(id).set(copy);
  } else {
    const newRef = dbRef.push();
    a.id = newRef.key;
    const copy={...a}; delete copy.id;
    return newRef.set(copy);
  }
}
function removeActivityRemote(id){
  if(!dbRef) return Promise.reject('No remote');
  return dbRef.child(id).remove();
}

/* =======================
   Render / Layout
   ======================= */
function renderAll(){
  dayCols.forEach(c=>{ Array.from(c.querySelectorAll('.activity')).forEach(n=>n.remove()); });
  DAYS.forEach(day=>{
    const acts = activities.filter(a=>a.day===day).map(a=>({...a, _startMin:timeToMinutes(a.start), _endMin:timeToMinutes(a.end)})).sort((a,b)=>a._startMin - b._startMin);
    const layouted = computeLayoutForDay(acts);
    layouted.forEach(a=>renderActivity(a));
  });
}

/* layout para solapamientos */
function computeLayoutForDay(items){
  const columns = [];
  items.forEach(item=>{
    let placed=false;
    for(let i=0;i<columns.length;i++){
      const last = columns[i][columns[i].length - 1];
      if(last._endMin <= item._startMin){ columns[i].push(item); item._col = i; placed = true; break; }
    }
    if(!placed){ columns.push([item]); item._col = columns.length - 1; }
  });
  items.forEach(item=>{
    const overlappingCols=[];
    for(let ci=0; ci<columns.length; ci++){
      if(columns[ci].some(it => !(it._endMin <= item._startMin || it._startMin >= item._endMin))){ overlappingCols.push(ci); }
    }
    item._totalCols = overlappingCols.length || 1;
    item._colIndex = overlappingCols.indexOf(item._col);
    if(item._colIndex < 0) item._colIndex = 0;
  });
  return items;
}

function renderActivity(a){
  const col = dayCols.find(c=>c.dataset.day===a.day); if(!col) return;
  const startMin = a._startMin ?? timeToMinutes(a.start);
  const endMin = a._endMin ?? timeToMinutes(a.end);
  const topMin = clamp(startMin - START_H*60, 0, (END_H-START_H)*60);
  const durMin = clamp(endMin - startMin, 15, (END_H-START_H)*60 - topMin);
  const topPx = (topMin/60) * HOUR_H;
  const heightPx = (durMin/60) * HOUR_H;

  const el = document.createElement('div'); el.className = 'activity';
  el.style.top = topPx + 'px';

  // altura final calculada (no usar offsetHeight por problemas en m√≥viles)
  const minH = 44;
  const finalHeight = Math.max(minH, Math.max(12, heightPx - 6));
  el.style.height = finalHeight + 'px';

  const cols = (a._totalCols && a._totalCols>0) ? a._totalCols : 1;
  const idx = (typeof a._colIndex === 'number') ? a._colIndex : 0;

  if(cols === 1){
    el.style.left = '6px';
    el.style.width = `calc(100% - 12px)`;
  } else {
    const leftPercent = (idx / cols) * 100;
    const widthPercent = (1 / cols) * 100;
    el.style.left = `${leftPercent}%`;
    el.style.width = `calc(${widthPercent}% - 8px)`;
  }

  el.style.background = a.color || '#60a5fa';
  el.dataset.id = a.id;
  el.tabIndex = 0;
  el.setAttribute('role', 'button');
  el.setAttribute('aria-label', `${a.title} ${a.start} a ${a.end}`);

  // contenido seguro
  const titleDiv = document.createElement('div'); titleDiv.className = 'title'; titleDiv.textContent = a.title || '';
  const descDiv = document.createElement('div'); descDiv.className = 'desc';
  descDiv.innerHTML = `${escapeHtml(a.start)} - ${escapeHtml(a.end)}${a.desc? '<br>' + escapeHtml(a.desc) : ''}`;

  el.appendChild(titleDiv);
  // mostramos o no la descripci√≥n seg√∫n altura calculada
  if(finalHeight >= 58) { el.appendChild(descDiv); }

  // tooltip con todo
  el.title = `${a.title} ‚Äî ${a.start} - ${a.end}${a.desc? '\n' + a.desc : ''}`;

  // accesibilidad / edici√≥n
  el.addEventListener('click', ev=>{ ev.stopPropagation(); startEdit(a.id); });
  el.addEventListener('keydown', ev=>{ if(ev.key === 'Enter' || ev.key === ' '){ ev.preventDefault(); startEdit(a.id);} });

  col.appendChild(el);
}

/* =======================
   Form / CRUD
   ======================= */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function resetForm(){
  inputTitle.value=''; inputDesc.value=''; inputColor.value='#60a5fa'; inputStart.value='08:00'; inputEnd.value='09:00'; inputDay.value=DAYS[0];
  editingId = null; btnAdd.style.display='inline-block'; btnUpdate.style.display='none'; btnDelete.style.display='none';
  inputTitle.focus();
}

function collectForm(){
  const title = inputTitle.value.trim(); if(!title){ alert('Pon un nombre a la actividad'); inputTitle.focus(); return null; }
  const start = inputStart.value; const end = inputEnd.value;
  if(!start || !end){ alert('Pon hora de inicio y fin'); return null; }
  if(timeToMinutes(end) <= timeToMinutes(start)){ alert('La hora de fin debe ser posterior al inicio'); return null; }
  return { day: inputDay.value, start, end, title, desc: inputDesc.value.trim(), color: inputColor.value };
}

/* Add / Update / Delete - usan Firebase si est√° configurado, si no usan localStorage */
async function addActivity(){
  const a = collectForm(); if(!a) return;
  if(REMOTE_ENABLED){
    // crea nueva key push
    const newRef = dbRef.push();
    a.id = newRef.key;
    await pushActivityToRemote(a);
    // el listener remoto actualizar√° la UI
  } else {
    a.id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    activities.push(a);
    saveLocal(); renderAll(); resetForm();
  }
  resetForm();
}

async function updateActivity(){
  if(!editingId) return;
  const a = collectForm(); if(!a) return;
  a.id = editingId;
  if(REMOTE_ENABLED){
    await pushActivityToRemote(a);
  } else {
    const idx = activities.findIndex(x=>x.id === editingId); if(idx >= 0) activities[idx] = a;
    saveLocal(); renderAll(); resetForm();
  }
  resetForm();
}

async function deleteActivity(){
  if(!editingId) return;
  if(!confirm('¬øBorrar esta actividad?')) return;
  if(REMOTE_ENABLED){
    await removeActivityRemote(editingId);
  } else {
    activities = activities.filter(x=>x.id !== editingId); saveLocal(); renderAll(); resetForm();
  }
  resetForm();
}

function startEdit(id){
  const a = activities.find(x=>x.id === id); if(!a) return;
  editingId = id;
  inputDay.value = a.day; inputStart.value = a.start; inputEnd.value = a.end; inputTitle.value = a.title; inputDesc.value = a.desc || ''; inputColor.value = a.color || '#60a5fa';
  btnAdd.style.display='none'; btnUpdate.style.display='inline-block'; btnDelete.style.display='inline-block';
  window.scrollTo({top:0,behavior:'smooth'});
  inputTitle.focus();
}

/* =======================
   Local storage backup
   ======================= */
function saveLocal(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(activities)); }catch(e){ console.warn('No se pudo guardar localStorage', e); }
}
function loadLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ activities = JSON.parse(raw) || []; }
  }catch(e){ activities = []; }
}

/* =======================
   Import/Export, events
   ======================= */
btnAdd.addEventListener('click', addActivity);
btnUpdate.addEventListener('click', updateActivity);
btnDelete.addEventListener('click', deleteActivity);
btnReset.addEventListener('click', resetForm);
btnPrint.addEventListener('click', ()=>window.print());

btnExport.addEventListener('click', ()=>{
  const dataStr = JSON.stringify(activities, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'campamento-planning.json'; a.click(); URL.revokeObjectURL(url);
});

btnImport.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader(); reader.onload = ()=>{
    try{
      const parsed = JSON.parse(reader.result);
      if(Array.isArray(parsed) && parsed.every(it=> it && typeof it.day === 'string' && typeof it.start === 'string' && typeof it.end === 'string' && typeof it.title === 'string')){
        if(confirm('¬øReemplazar las actividades locales con las del archivo? Pulsa CANCELAR para MERGEAR')){ activities = parsed; } else { activities = activities.concat(parsed); }
        if(REMOTE_ENABLED){
          // subir todas las actividades remotas es complejo; mejor dejar que el listener remoto haga merge
          alert('Importado localmente. Si usas Firebase, espera a que se sincronicen o sube manualmente.');
        }
        saveLocal(); renderAll(); alert('Importado ‚úî');
      } else alert('JSON no v√°lido: espera un array de actividades con propiedades day, start, end, title.');
    }catch(err){ alert('Error al leer JSON'); console.error(err); }
  };
  reader.readAsText(f); e.target.value = '';
});

/* crear evento click en columnas para crear r√°pida */
dayCols.forEach(col=>{
  col.addEventListener('click', ev=>{
    if(ev.target.closest('.activity')) return;
    const rect = col.getBoundingClientRect();
    const y = ev.clientY - rect.top;
    const minutes = START_H*60 + (y / HOUR_H) * 60;
    let hh = Math.floor(minutes/60);
    let mm = Math.round((minutes%60)/15)*15;
    if(mm === 60){ hh += 1; mm = 0; }
    inputDay.value = col.dataset.day;
    inputStart.value = String(hh).padStart(2,'0') + ':' + String(mm).padStart(2,'0');
    let endMin = minutes + 60; let endH = Math.floor(endMin/60); let endM = Math.round((endMin%60)/15)*15;
    if(endM === 60){ endH += 1; endM = 0; }
    if(endH >= 24){ endH = 23; endM = 59; }
    inputEnd.value = String(endH).padStart(2,'0') + ':' + String(endM).padStart(2,'0');
    window.scrollTo({top:0,behavior:'smooth'}); inputTitle.focus();
  });
});

/* =======================
   Inicializaci√≥n final
   ======================= */
function load(){
  // si hay firebase config, inicializamos y usamos remoto
  initFirebaseIfConfigured();

  // si remoto no carg√≥ todav√≠a, usamos local como fallback inmediato
  if(!REMOTE_ENABLED){
    loadLocal();
    renderAll();
  } else {
    // si remoto est√° activado, load() confiar√° en el listener remoto para poblar la UI
    // pero tambi√©n mostramos local temporalmente hasta que llegue el remoto
    loadLocal();
    if(Array.isArray(activities) && activities.length > 0){
      renderAll();
    }
    // el listener remoto (attachFirebaseListeners) reemplazar√° la vista cuando llegue snapshot
  }
}

load();

</script>
</body>
</html>
