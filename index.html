<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calendario Campamento - Semana Santa 2026</title>

<!-- Firebase (v8) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<style>
:root{
  --bg:#f4fbf6;
  --card:#ffffff;
  --accent:#2f855a;
  --muted:#6b7280;
  --hour-height:60px;
  --start-hour:8;
  --end-hour:23;
}
*{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
body{margin:0;background:var(--bg);color:#0f172a;padding:12px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{margin:0;font-size:18px}
.wrap{display:grid;grid-template-columns:360px 1fr;gap:14px;margin-top:12px;align-items:start;}

/* panel */
.panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input[type=text], textarea, select, input[type=time], input[type=color]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6edf3;margin-top:6px}
textarea{min-height:80px;resize:vertical}
.row{display:flex;gap:8px}
.btn{display:inline-block;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.btn-primary{background:var(--accent);color:white}
.btn-ghost{background:transparent;border:1px solid #e6edf3}
.small{font-size:13px}
.muted{color:var(--muted);font-size:13px}

/* calendario - desktop */
.calendar{background:transparent}
.calendar-grid{display:grid;grid-template-columns:80px repeat(4,1fr);gap:8px;align-items:start}
.col-header{height:44px;display:flex;align-items:center;justify-content:center;font-weight:600;background:linear-gradient(90deg, rgba(47,133,90,0.08), rgba(47,133,90,0.02));border-radius:8px;padding:6px}
.hour-col{display:flex;flex-direction:column}
.hour-label{height:var(--hour-height);text-align:right;padding-right:10px;padding-top:8px;color:var(--muted);font-size:13px}
.day-column{background:var(--card);border-radius:8px;padding:0;position:relative;overflow:hidden;min-height:calc((var(--end-hour) - var(--start-hour)) * var(--hour-height));height:calc((var(--end-hour) - var(--start-hour)) * var(--hour-height));box-shadow:0 4px 14px rgba(2,6,23,0.04)}
.hour-line{height:var(--hour-height);border-bottom:1px dashed #eef2f6}

/* actividad */
.activity{
  position:absolute;
  border-radius:10px;
  padding:8px 10px;
  color:#fff;
  box-shadow:0 6px 12px rgba(2,6,23,0.12);
  font-size:14px;
  cursor:pointer;
  overflow:hidden;
  line-height:1.2;
  z-index:5;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  justify-content:center;
  min-width:48px;
  user-select:none;
}
.activity:focus{outline:3px solid rgba(255,255,255,0.18);outline-offset:2px}
.activity .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.activity .desc{font-size:12px;opacity:0.95;white-space:normal;overflow:hidden;margin-top:6px;line-height:1.2}

/* MOBILE: mobile-first tweaks */
@media (max-width:900px){
  body{padding:8px}
  .wrap{grid-template-columns:1fr;gap:10px}
  .panel{order:-1}
  .calendar-grid{
    grid-template-columns:60px repeat(4, minmax(220px, 1fr));
    gap:10px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    padding-bottom:10px;
  }
  .col-header{font-size:15px;padding:8px 10px}
  .hour-label{padding-right:6px;font-size:12px;height:48px}
  .activity{padding:8px 10px;font-size:15px;border-radius:12px}
  .panel{padding:10px}
  .btn{padding:10px 12px;font-size:15px}
}

/* MOBILE VERTICAL: stacked day view */
@media (max-width:420px){
  .calendar-grid{display:block;padding:6px;gap:8px}
  .day-block{display:block;margin-bottom:12px;background:transparent}
  .day-block .day-inner{display:flex;gap:8px}
  .day-block .hours-side{width:68px;background:transparent;border-radius:8px;padding:6px;box-sizing:border-box}
  .day-block .hours-side .hour-label{height:40px;padding-top:10px;font-size:12px;text-align:left;padding-left:6px;color:var(--muted)}
  .day-block .day-column-mobile{flex:1;background:var(--card);border-radius:8px;position:relative;min-height:320px;height:auto;box-shadow:0 4px 14px rgba(2,6,23,0.04);overflow:hidden}
  .day-block .day-header{font-weight:700;margin-bottom:6px}
  .hour-line{border-bottom:1px dashed #eef2f6;height:40px}
}
</style>
</head>
<body>
<header>
  <div>
    <h1>ðŸ“… Calendario - Campamento Semana Santa 2026</h1>
    <div id="syncStatus" class="muted">Modo: local (sin Firebase)</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button id="btnPrint" class="btn btn-ghost small">Imprimir / Guardar PDF</button>
    <button id="btnExport" class="btn btn-ghost small">Descargar JSON</button>
    <button id="btnImport" class="btn btn-ghost small">Importar JSON</button>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Crear / Editar actividad</strong>
      <button id="btnReset" class="btn btn-ghost small">Limpiar</button>
    </div>

    <label>DÃ­a</label>
    <select id="inputDay">
      <option>Viernes 27</option>
      <option>SÃ¡bado 28</option>
      <option>Domingo 29</option>
      <option>Lunes 30</option>
    </select>

    <div class="row">
      <div style="flex:1">
        <label>Inicio</label>
        <input id="inputStart" type="time" value="08:00" />
      </div>
      <div style="flex:1">
        <label>Fin</label>
        <input id="inputEnd" type="time" value="09:00" />
      </div>
    </div>

    <label>Nombre</label>
    <input id="inputTitle" type="text" placeholder="Ej. Ruta por la sierra" />

    <label>DescripciÃ³n</label>
    <textarea id="inputDesc" placeholder="Detalles, materiales, quiÃ©n dirige..."></textarea>

    <label>Color</label>
    <input id="inputColor" type="color" value="#60a5fa" />

    <div class="controls" style="display:flex;gap:8px;margin-top:10px">
      <button id="btnAdd" class="btn btn-primary">AÃ±adir actividad</button>
      <button id="btnUpdate" class="btn btn-ghost" style="display:none">Guardar cambios</button>
      <button id="btnDelete" class="btn btn-ghost" style="display:none">Borrar</button>
    </div>
  </div>

  <div class="calendar panel">
    <div class="calendar-grid" id="calendarGrid">
    </div>
  </div>
</div>

<input id="fileInput" type="file" accept="application/json" style="display:none" />

<script>
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAhzhr7P7m1CDYZhQPwtP78OEm6jGwwDGE",
  authDomain: "camp-sem-sant.firebaseapp.com",
  databaseURL: "https://camp-sem-sant-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "camp-sem-sant",
  storageBucket: "camp-sem-sant.firebasedstorage.app",
  messagingSenderId: "483863490995",
  appId: "1:483863490995:web:5474b5a0984553baf29bc6"
};
let REMOTE_ENABLED = true;

const DAYS=["Viernes 27","SÃ¡bado 28","Domingo 29","Lunes 30"];
const HOUR_H=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--hour-height'))||60;

const calendarGrid = document.getElementById('calendarGrid');
const syncStatusEl = document.getElementById('syncStatus');
const STORAGE_KEY = 'campamento-semanasanta-2026';
let activities = [];
let dayCols = [];

const inputDay=document.getElementById('inputDay');
const inputStart=document.getElementById('inputStart');
const inputEnd=document.getElementById('inputEnd');
const inputTitle=document.getElementById('inputTitle');
const inputDesc=document.getElementById('inputDesc');
const inputColor=document.getElementById('inputColor');
const btnAdd=document.getElementById('btnAdd');
const btnUpdate=document.getElementById('btnUpdate');
const btnDelete=document.getElementById('btnDelete');
const btnReset=document.getElementById('btnReset');
const btnPrint=document.getElementById('btnPrint');
const btnExport=document.getElementById('btnExport');
const btnImport=document.getElementById('btnImport');
const fileInput=document.getElementById('fileInput');

let editingId = null;
let dbRef = null;
let remoteLoaded = false;

/* ======================= Firebase init ======================= */
function initFirebaseIfConfigured(){
  try{
    if(FIREBASE_CONFIG && Object.keys(FIREBASE_CONFIG).length>2 && typeof firebase !== 'undefined'){
      firebase.initializeApp(FIREBASE_CONFIG);
      firebase.auth().signInAnonymously().catch(()=>{});
      dbRef = firebase.database().ref('activities');
      REMOTE_ENABLED = true;
      syncStatusEl.textContent = 'Modo: sincronizaciÃ³n activa (Firebase)';
      attachFirebaseListeners();
    } else { REMOTE_ENABLED=false; syncStatusEl.textContent='Modo: local (sin Firebase)'; }
  }catch(e){ REMOTE_ENABLED=false; syncStatusEl.textContent='Modo: local (error Firebase)'; console.warn(e); }
}

function attachFirebaseListeners(){
  if(!dbRef) return;
  dbRef.on('value', snapshot=>{
    const data = snapshot.val()||{};
    activities = Object.keys(data).map(k=>({id:k,...data[k]}));
    try{ localStorage.setItem(STORAGE_KEY,JSON.stringify(activities)); }catch(e){}
    renderAll();
    remoteLoaded=true;
  });
}

/* ======================= Rango dinÃ¡mico de horas ======================= */
function calcularRangoHoras(){
  let minH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--start-hour'))||8;
  let maxH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--end-hour'))||23;
  for(const a of activities){
    let s = timeToMinutes(a.start);
    let e = timeToMinutes(a.end);
    if(e <= s) e += 24*60;
    minH = Math.min(minH, Math.floor(s/60));
    maxH = Math.max(maxH, Math.ceil(e/60));
  }
  return [minH,maxH];
}

/* ======================= Construir calendario ======================= */
function buildCalendarLayout(){
  const isNarrow = window.innerWidth <= 420;
  calendarGrid.innerHTML='';
  const [dynStartH,dynEndH]=calcularRangoHoras();
  const totalH = dynEndH-dynStartH;

  if(!isNarrow){
    const empty=document.createElement('div'); calendarGrid.appendChild(empty);
    for(const d of DAYS){ const h=document.createElement('div'); h.className='col-header'; h.textContent=d; calendarGrid.appendChild(h);}
    const hoursCol=document.createElement('div'); hoursCol.className='hour-col';
    for(let hh=dynStartH; hh<dynEndH; hh++){ const lab=document.createElement('div'); lab.className='hour-label'; lab.textContent=String(hh).padStart(2,'0')+':00'; hoursCol.appendChild(lab);}
    calendarGrid.appendChild(hoursCol);
    for(const d of DAYS){
      const col=document.createElement('div'); col.className='day-column'; col.dataset.day=d;
      for(let hh=dynStartH; hh<dynEndH; hh++){ const line=document.createElement('div'); line.className='hour-line'; col.appendChild(line);}
      calendarGrid.appendChild(col);
    }
    dayCols = Array.from(document.querySelectorAll('.day-column'));
  } else {
    for(const d of DAYS){
      const block=document.createElement('div'); block.className='day-block';
      const header=document.createElement('div'); header.className='day-header'; header.textContent=d; block.appendChild(header);
      const inner=document.createElement('div'); inner.className='day-inner';
      const hoursSide=document.createElement('div'); hoursSide.className='hours-side';
      for(let hh=dynStartH; hh<dynEndH; hh++){ const lab=document.createElement('div'); lab.className='hour-label'; lab.textContent=String(hh).padStart(2,'0')+':00'; hoursSide.appendChild(lab);}
      inner.appendChild(hoursSide);
      const col=document.createElement('div'); col.className='day-column-mobile'; col.dataset.day=d;
      for(let hh=dynStartH; hh<dynEndH; hh++){ const line=document.createElement('div'); line.className='hour-line'; col.appendChild(line);}
      inner.appendChild(col); block.appendChild(inner); calendarGrid.appendChild(block);
    }
    dayCols=Array.from(document.querySelectorAll('.day-column-mobile'));
  }

  // click handler
  dayCols.forEach(col=>{
    col.onclick=null;
    col.addEventListener('click', ev=>{
      if(ev.target.closest('.activity')) return;
      const rect=col.getBoundingClientRect(); const y=ev.clientY-rect.top;
      let [minH,maxH]=calcularRangoHoras();
      const minutes=minH*60 + (y/HOUR_H)*60;
      let hh=Math.floor(minutes/60); let mm=Math.round((minutes%60)/15)*15;
      if(mm===60){ hh+=1; mm=0; }
      inputDay.value=col.dataset.day;
      inputStart.value=String(hh).padStart(2,'0')+':'+String(mm).padStart(2,'0');
      let endMin=minutes+60; let endH=Math.floor(endMin/60); let endM=Math.round((endMin%60)/15)*15;
      if(endM===60){ endH+=1; endM=0; }
      if(endH>=24){ endH=23; endM=59; }
      inputEnd.value=String(endH).padStart(2,'0')+':'+String(endM).padStart(2,'0');
      window.scrollTo({top:0,behavior:'smooth'}); inputTitle.focus();
    });
  });
}

/* ======================= Render ======================= */
function renderAll(){
  buildCalendarLayout();
  dayCols.forEach(c=>Array.from(c.querySelectorAll('.activity')).forEach(n=>n.remove()));
  const [dynStartH,dynEndH]=calcularRangoHoras();

  DAYS.forEach(day=>{
    const acts=activities.filter(a=>a.day===day).map(a=>({...a,_startMin:timeToMinutes(a.start),_endMin:timeToMinutes(a.end)})).sort((a,b)=>a._startMin-a._startMin);
    acts.forEach(a=>{
      const col=dayCols.find(c=>c.dataset.day===day); if(!col) return;
      let startM=a._startMin; let endM=a._endMin; if(endM<=startM) endM+=24*60;
      const totalM=(dynEndH-dynStartH)*60;
      const topPx=((startM-dynStartH*60)/totalM)*col.clientHeight;
      const heightPx=((endM-startM)/totalM)*col.clientHeight;

      const el=document.createElement('div'); el.className='activity';
      el.style.top=topPx+'px'; el.style.height=Math.max(44,heightPx)+'px';
      el.style.left='6px'; el.style.width='calc(100% - 12px)';
      el.style.background=a.color||'#60a5fa';
      el.dataset.id=a.id;
      el.tabIndex=0;
      el.innerHTML=`<div class="title">${a.title}</div><div class="desc">${a.desc}</div>`;
      el.onclick=ev=>{
        ev.stopPropagation(); editingId=a.id;
        inputDay.value=a.day; inputStart.value=a.start; inputEnd.value=a.end;
        inputTitle.value=a.title; inputDesc.value=a.desc; inputColor.value=a.color||'#60a5fa';
        btnAdd.style.display='none'; btnUpdate.style.display='inline-block'; btnDelete.style.display='inline-block';
      };
      col.appendChild(el);
    });
  });
}

/* ======================= Util ======================= */
function timeToMinutes(t){ const [hh,mm]=t.split(':').map(Number); return hh*60+mm; }
function saveLocal(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(activities)); }
function resetForm(){ editingId=null; inputTitle.value=''; inputDesc.value=''; inputColor.value='#60a5fa'; btnAdd.style.display='inline-block'; btnUpdate.style.display='none'; btnDelete.style.display='none'; }

/* ======================= CRUD ======================= */
btnAdd.onclick=()=>{
  const a={id:'id'+Date.now(), day:inputDay.value, start:inputStart.value, end:inputEnd.value, title:inputTitle.value, desc:inputDesc.value, color:inputColor.value};
  activities.push(a);
  if(REMOTE_ENABLED && dbRef){ dbRef.child(a.id).set(a); } else { saveLocal(); renderAll(); }
  resetForm();
};
btnUpdate.onclick=()=>{
  const a=activities.find(a=>a.id===editingId); if(!a) return;
  a.day=inputDay.value; a.start=inputStart.value; a.end=inputEnd.value; a.title=inputTitle.value; a.desc=inputDesc.value; a.color=inputColor.value;
  if(REMOTE_ENABLED && dbRef){ dbRef.child(a.id).set(a); } else { saveLocal(); renderAll(); }
  resetForm();
};
btnDelete.onclick=()=>{
  activities=activities.filter(a=>a.id!==editingId);
  if(REMOTE_ENABLED && dbRef){ dbRef.child(editingId).remove(); } else { saveLocal(); renderAll(); }
  resetForm();
};
btnReset.onclick=resetForm;
btnPrint.onclick=()=>window.print();
btnExport.onclick=()=>{ const blob=new Blob([JSON.stringify(activities,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='actividades.json'; a.click(); };
btnImport.onclick=()=>fileInput.click();
fileInput.onchange=e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{ const data=JSON.parse(ev.target.result); activities=data; saveLocal(); renderAll(); }catch(e){alert('Error JSON');}
  };
  reader.readAsText(file);
};

/* ======================= Init ======================= */
function init(){
  const saved = localStorage.getItem(STORAGE_KEY);
  if(saved){ try{ activities=JSON.parse(saved); }catch(e){} }
  renderAll();
  initFirebaseIfConfigured();
}
window.onload=init;
window.onresize=renderAll;
</script>
</body>
</html>
